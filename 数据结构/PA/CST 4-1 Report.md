# CST 4-1 Report

## 算法构思

本题需要维护这样一个数据结构：对于$\forall i, i\in[0,n)$

- 存有$[max(0,i-k-1),min(n-1,i+k+1)]$这一区间窗口内所有原件的信息
- 可以查询这一范围内和i异或值最大的字符串id
- 可以动态删去某个字符串和添加某个字符串到这个数据结构中

基于此，我们最终选择**字典树**这一数据结构，下面对其进行详细介绍。

#### 字典树：规则

对字典树的理解可以类比有限状态自动机（DFA），本题中字母表$\Sigma = \{0,1\}$，树的根节点相当于是自动机入口。从入口开始，每经过一个结点，01串将自己的第一个字符取出，如果是0则转向结点的左子树，是1则转向右子树，直到走到树的叶结点为止，每个叶结点可以视作自动机的一个终态

对于每个**结点**，用`cnt`存储路径经过这个结点的字符串数量

对于每个**叶结点**，还要记录这个终态对应的字符串的id值，由于可能存在多个id值的字符串相同的情况，这里的id值记录的是所有存在树中对应这一终态的字符串id最小值，$ \_id = min(\{id | str[id] \and  id\in [max(0,i-k-1),min(n-1,i+k+1)]\}) $，这一操作是为了满足题目要求中“**输出所有窗口内和id=i异或值最大的字符串id的最小值**”要求。

#### 字典树：初始化

由于本题字母表中只有两个字母，所以字典树实际上是一棵高度等于64的二叉树。每个结点的左右子树分别代表接受0和1后转移到的状态。

#### 字典树：动态变化

每当我们变换窗口时，字典树中都可能会插入一个字符串并删除一个字符串（当窗口移动到两端附近时，也可能出现不删除或不插入的情况）

#### 字典树：插入

考虑插入一个64位的01字符串`original[i]`。

从根节点开始，按照字典树转向规则深探，如果结点并没有对应的孩子，则创建它，同时我们将沿途经过的所有结点计数值加1，表示经过这一节点的字符串多了一个。

探到叶结点后，更新叶结点的id值，这要求我们插入的字符串一定是当前窗口中的最小值，**因此，我们的窗口应该是从右往左移动，而非从左往右移动。**

#### 字典树：删除

考虑删除一个64位的01字符串`original[i]`，这一字符串此前一定已经插入在树中。

从根节点开始，按照字典树转向规则深探，同时我们将沿途经过的所有结点计数值减1，表示经过这一节点的字符串少了一个。

#### 字典树：查询

考虑查询j，使得$j\neq i \and j \in [max(0,i-k-1),min(n-1,i+k+1)]$且`original[j]`和`original[i]`异或值最大。异或值查询满足**贪心条件**，只需要每次都转向异或值最大的方向即可，具体来说就是如果有结点两个孩子的话，接收0后转向右子树，接收1后转向左子树，这样最终到达的终态得到一个id值即是所求结果。

一般来说，上述办法找到的id值和i是不同的，除非一种情况：**i=0且窗口内所有字符串相同，此时找到的id为0**，但根据题目要求，id值应该为1，这里需要特判一下。

## 时间和空间复杂度的估算

**时间复杂度：**每个元件至多被插入一次、删除一次，对于每次插入、删除操作，时间复杂度均正比于树高$O(64)=O(1)$，而对n个元件，我们的时间复杂度为$O(n)$

**空间复杂度：**考虑到每个字典树的结点都可能代表一个字符，字典树的总结点个数应该不大于$O(64n)$，其它的数组空间规模也符合$O(n)$，总的空间复杂度应是$O(n)$的。但这只是一个相当宽泛的上界，存在被卡常的可能。考虑到字典树靠近根节点的结点应该是可以复用的，下面对其进行更精细的分析：

考虑n的最大值$n=5\times10^5$，假设某一时刻窗口能够涵盖所有的字符串，n对2取对数后可以得到，前19层的树是满的，从第20层开始每个字符串对应一条单链，这样的结点数就达到了理论上的最大值，总个数为$2^{20}+5\times10^5\times(64-19)=23548576$。因此，理论上字典树占的空间为359.32MB（每个结点存4个int，空间大小为16byte）

`bool original[500001][64]`数组存储了所有原件字符串信息，空间复杂度为$O(64n)=O(n)$，占空间大小为$64\times500001B=30.51MB$

因为窗口是从右往左移动的，还需要`int res[500001]`数组来存储结果，空间复杂度为$O(n)$，占空间大小为$4\times500001B=1.97MB$

总的占空间大小为$359.32+30.51+1.97=391.8MB< 512MB$

